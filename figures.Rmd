---
title: "DCS Typhi in Blantyre"
author: "Philip Ashton"
date: "30/08/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(tidyverse)
library(readxl)
library(broom)
library(lubridate)
```

## Figure 1

This is a figure of the number of S. Typhi at QECH that were cipro sensitive and DCS.

```{r Figure1}
line_list_handle <- "~/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2022.04.08/2022.04.08 line list.xlsx"

all_typhi <- read_excel(line_list_handle, sheet = "all typhi", col_types = c("text", "text", "text", 
                                                                             "text", "date", "text", "text", "numeric", 
                                                                             "text", "text", "text", "text", "text", 
                                                                             "text", "text", "text", "numeric", 
                                                                             "text", "text", "text", "text", "text", 
                                                                             "text"))

pef_tested_qech_typhi <- all_typhi %>% filter(grepl('QECH', Study)) %>% filter(!is.na(`Cipro MIC res?`))

pef_tested_qech_typhi$Month <- as.Date(cut(pef_tested_qech_typhi$`Properly formatted date`, breaks = "month"))


pef_by_month <- pef_tested_qech_typhi %>% group_by(Month, `Cipro MIC res?`) %>% summarise(n = n())

pef_by_month <- pef_by_month %>% filter(Month >= "2019-01-01")

ggplot(pef_by_month, aes(x = Month, y = n, fill = `Cipro MIC res?`)) + 
  geom_bar(stat = "identity") + 
  ylab("Number of samples") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14))

ggplot(pef_by_month, aes(x = Month, y = n, fill = `Cipro MIC res?`, label = n)) + 
  geom_bar(position = 'fill', stat = "identity") + 
  ylab("Number of samples") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14))
```

## Figure 2

```{r}
d <- read_csv('/Users/flashton/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/epi_analysis/results/2022.06.17/2022.06.17.combined_typhi_data.csv')
d <- d |>
  mutate(date = ymd(Month)) |>
  arrange(date) |>
  mutate(month_number = row_number()) |>
  mutate(total_cases = no_qrdr + any_qrdr) |>
  rename(`Cipro\nprescriptions` = `elible_ciprofloxacin prescribed`)

e <- d |>
  dplyr::select(date, `Cipro\nprescriptions`, no_qrdr, any_qrdr, total_cases) |>
  pivot_longer(-date)

e |>
  ggplot() +
  geom_col(aes(x=date, y=value, fill=name)) +
  facet_grid(name~., scales = "free_y") +
  theme_linedraw() +
  scale_fill_brewer(palette="Set1") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
  labs(x="Month",
       y="Count") +
  scale_x_date(breaks = scales::breaks_pretty(20)) +
  scale_y_continuous(breaks = scales::breaks_pretty(5))
```

