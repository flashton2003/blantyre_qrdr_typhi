---
title: "DCS Typhi in Blantyre"
author: "Philip Ashton"
date: "08/09/2022"
output: 
  html_document:
      toc: true
      toc_float: true
      theme: united
      number_sections: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
```

In this document we are analysing Salmonella Typhi from the STRATAA and TyVAC studies. In particular, we are interested in the relationship between QRDR S. Typhi (i.e. Typhi that has mutations in the quinolone resistance determining regions) and the number of ciprofloxacin prescriptions. Other co-variables included in the model are: number of typhoid cases and number of blood cultures carried out.

# Todo/questions

1. What part of the current model specification specifies a zero-inflated model?
2. Should the co-variable be the total number of typhi, or the total number of typhi that don't have the QRDR mutation?
3. Need to do the serial autocorrelation analysis

# Libraries

```{r message=FALSE}
library(tidyverse)
library(readxl)
library(broom)
library(lubridate)
#library(here)
library(glmmTMB)
library(tsibble)
library(feasts)
library(trending)
library(patchwork)
library(kableExtra)
```

# Key variables

`tyvac_pop` is the ndirande intention to treat population (or should we use the per protocol number?). `strataa_pop` is the population size at the final census (aug 2018-April 2019). `tyvac_strataa_start` and `tyvac_strataa_end` are the start and finish of the period of overlap between strataa and tyvac.

```{r KeyVariables}
tyvac_pop <- 17695 # 
strataa_pop <- 102242 # 
tyvac_strataa_start <- as.Date('2018-05-01')
tyvac_strataa_end <- as.Date('2019-10-01')
strataa_start <- as.Date('2016-11-01')
strataa_end <- as.Date('2019-10-31')
```

# Import data

Here we import all the files needed for this analysis.

Todo:

* make sure excluding multiple isolates from the same person (get PIDs for both STRATAA and TyVAC)
* get the definitive line list of all typhis from STRATAA

```{r ImportData}

line_list_handle <- "~/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2022.09.08/2022.09.08 line list.xlsx"

all_typhi <- read_excel(line_list_handle, col_types = c("text", "text", "text", "text",
        "text", "date", "text", "text", "numeric", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "numeric", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text", "text", "text"))

all_typhi$Month <- as.Date(cut(all_typhi$`Properly formatted date`, breaks = "month"))
# Note starts with "Ignore" if there is some reason the sample should be ignored
all_typhi <- all_typhi %>% mutate(any_qrdr = ifelse(is.na(QRDR), NA, "QRDR")) %>% filter(!grepl("^Ignore", Note))

# ps12_dov is the date of visit
strataa_prescriptions <- read_csv("/Users/flashton/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2021.04.08/2021.04.01 strataa_ndirande_prescribed from James Meiring.csv", col_types = cols(ps12_dov = col_datetime(format = "%d/%m/%Y %H:%M")))
strataa_prescriptions$Month <- as.Date(cut(strataa_prescriptions$ps12_dov, breaks = "month"))
# ps44_cipro is 1 if cipro was prescribed
strataa_prescriptions <- strataa_prescriptions %>% filter(ps44_cipro == 1)

# this data is already tabulated by month
tyvacpresc_by_month <- read_csv("/Users/flashton/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2021.04.08/2021.04.08 cipro prescriptions.csv", col_types = cols(Month = col_date(format = "%d/%m/%Y")))

tyvac_blood_cultures_by_month <- read_csv("~/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2021.11.12/TyVAC monthly BC.csv", col_types = cols(date = col_date(format = "%Y-%m-%d"))) %>% rename('Month' = 'date', 'tyvac_bc_n' = 'BC collected')

strataa_blood_cultures <- read_csv("~/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2021.11.12/STRATAA.ps_enrolment.date_only.csv", col_types = cols(ps12_dov = col_date(format = "%Y-%m-%d")))
strataa_blood_cultures$Month <- as.Date(cut(strataa_blood_cultures$ps12_dov, breaks = "month"))

```

# Sequencing confirmed typhoid incidence rate

Here we filter the input line list to extract the *sequenced* tyvac samples from ndirande and the sequenced strataa samples. `cases_start` and `cases_end` are defined here.

```{r}
tyvac_cases <- all_typhi %>% filter(Study == 'TyVAC' & `TyVAC site` == 'Ndirande'  & !is.na(`Sequenced?`))  %>% filter(`overall sequencing identification` == "Typhi")
tyvac_cases_by_month <- tyvac_cases %>% group_by(Month) %>% summarise(tyvac_n = n())

# we use grepl to find "strataa adjacent" samples as well as strataa samples.
strataa_cases <- all_typhi %>% filter(grepl('STRATAA', Study) & !is.na(`Sequenced?`)) %>% filter(`overall sequencing identification` == "Typhi")

strataa_cases_by_month <- strataa_cases  %>% group_by(Month) %>% summarise(strataa_n = n())
strataa_cases_by_month$strataa_typhoid_per100000 <- (strataa_cases_by_month$strataa_n / strataa_pop) * 100000

cases_start <- min(strataa_cases_by_month$Month, tyvac_cases_by_month$Month)
cases_end <- max(strataa_cases_by_month$Month, tyvac_cases_by_month$Month)

# get the official start date of tyvac, as this will determine the start period
combined_cases_by_month <- data.frame(Month = seq(cases_start, cases_end, "months")) 
#combined_by_month <- combined_by_month %>% rename(V1 = Month)
combined_cases_by_month <- left_join(combined_cases_by_month, tyvac_cases_by_month, by = 'Month')
combined_cases_by_month <- left_join(combined_cases_by_month, strataa_cases_by_month, by = 'Month')
combined_cases_by_month[is.na(combined_cases_by_month)] <- 0

combined_cases_by_month$total_typhoid_n <- combined_cases_by_month$tyvac_n + combined_cases_by_month$strataa_n
combined_cases_by_month$total_typhoid_per100000 <- (combined_cases_by_month$total_typhoid_n / strataa_pop) * 100000

```

# QRDR Typhi incidence

```{r}

strataa_qrdr <- strataa_cases %>% filter(any_qrdr == 'QRDR')
strataa_qrdr_cases_by_month <- strataa_qrdr  %>% group_by(Month) %>% summarise(strataa_qrdr_n = n())
strataa_qrdr_cases_by_month$strataa_qrdr_incidence_per_100000 <- (strataa_qrdr_cases_by_month$strataa_qrdr_n / strataa_pop) * 100000

tyvac_qrdr <- tyvac_cases %>% filter(any_qrdr == 'QRDR')
tyvac_qrdr_cases_by_month <- tyvac_qrdr  %>% group_by(Month) %>% summarise(tyvac_qrdr_n = n())

combined_qrdr_cases_by_month <- data.frame(Month = seq(cases_start, cases_end, "months")) 

combined_qrdr_cases_by_month <- left_join(combined_qrdr_cases_by_month, strataa_qrdr_cases_by_month, by = 'Month')
combined_qrdr_cases_by_month <- left_join(combined_qrdr_cases_by_month, tyvac_qrdr_cases_by_month, by = 'Month')

combined_qrdr_cases_by_month[is.na(combined_qrdr_cases_by_month)] <- 0

combined_qrdr_cases_by_month$total_qrdr_n <- combined_qrdr_cases_by_month$strataa_qrdr_n + combined_qrdr_cases_by_month$tyvac_qrdr_n

combined_qrdr_cases_by_month$total_qrdr_incidence_per_100000 <- (combined_qrdr_cases_by_month$total_qrdr_n / strataa_pop) * 100000

```

# Cipro prescription incidence rates

```{r}
strataa_presc_by_month <- strataa_prescriptions %>% group_by(Month) %>% summarise(strataa_prescrip_n = n())
#ggplot(strataa_prescriptions)
strataa_presc_by_month$strataa_prescrip_per100000 <- (strataa_presc_by_month$strataa_prescrip_n / strataa_pop) * 100000

combined_prescrip_by_month <- data.frame(Month = seq(cases_start, cases_end, "months")) 
combined_prescrip_by_month <- left_join(combined_prescrip_by_month, tyvacpresc_by_month, by = 'Month')
combined_prescrip_by_month <- left_join(combined_prescrip_by_month, strataa_presc_by_month, by = 'Month')
# currently only including prescriptions to eligible tyvac participants, not ineligible
# ineligible prescriptions also add to the total pressure, but it should be negligible compared with the prescriptions
# to eligible people?

combined_prescrip_by_month[is.na(combined_prescrip_by_month)] <- 0

combined_prescrip_by_month$total_prescrip_n <- combined_prescrip_by_month$tyvac_eligible_ciprofloxacin_prescribed + combined_prescrip_by_month$strataa_prescrip_n

combined_prescrip_by_month$total_prescrip_per_100000 <- (combined_prescrip_by_month$total_prescrip_n / strataa_pop) * 100000

#tyvacpresc_by_month$tyvac_prescrip_eligible_per100000 <- (tyvacpresc_by_month$tyvac_eligible_ciprofloxacin_prescribed / tyvac_pop) * 100000
#tyvacpresc_by_month$tyvac_prescrip_not_eligible_per100000 <- (tyvacpresc_by_month$tyvac_not_eligible_ciprofloxacin_prescribed / tyvac_pop) * 100000

#prescrip_end <- max(strataa_prescriptions$Month, tyvacpresc_by_month$Month)
##prescrip_start <- min(strataa_prescriptions$Month, tyvacpresc_by_month$Month)

```

# Getting the number of blood cultures

```{r}

strataa_blood_cultures_by_month <- strataa_blood_cultures %>% group_by(Month) %>% summarise(strataa_blood_cultures_n = n())
strataa_blood_cultures_by_month$strataa_bc_per_100000 <- (strataa_blood_cultures_by_month$strataa_blood_cultures_n / strataa_pop) * 100000

combined_blood_cultures <- data.frame(Month = seq(cases_start, cases_end, "months"))
combined_blood_cultures <- left_join(combined_blood_cultures, tyvac_blood_cultures_by_month, by = 'Month')

combined_blood_cultures <- left_join(combined_blood_cultures, strataa_blood_cultures_by_month, by = 'Month')
combined_blood_cultures[is.na(combined_blood_cultures)] <- 0


combined_blood_cultures$total_bc_n <- combined_blood_cultures$tyvac_bc_n + combined_blood_cultures$strataa_blood_cultures_n
combined_blood_cultures$total_bc_per_100000 <- (combined_blood_cultures$total_bc_n / strataa_pop) * 100000

```


# Investigating associations
## define function to run models

From PeterMacP:

"Model 1: Here we are testing the hypothesis that increased month presciptions of ciprofloxacin was associated with increased numbers of cases of drug resistant typhoid.

We will initially construct a zero-inflated negative binomial regression model to investigate this association. We select the zero-inflated negative binomial distributional family because it is likely that the data are overdispersed, and because of the excess zero months."

```{r}
run_models <- function(input_data) {
  
  m3 <- glmmTMB(total_qrdr_incidence_per_100000 ~ total_prescrip_per_100000 + total_bc_per_100000 + total_typhoid_per100000,  data = input_data, family = "nbinom1")
  #summary(m3)
  m3_summary <- broom.mixed::tidy(m3, exponentiate = TRUE, conf.int = TRUE)
  
  return(m3_summary)
}
```

## Marc's way

Going to do one model with all the data from the entire study period. Doesn't matter about the difference in recruitment criteria between strataa and tyvac because the important thing is the number of qrdr typhi per typhoid case, and the method of detecting those was consistent.

```{r}

qrdr_per_month <- select(combined_qrdr_cases_by_month, c('Month', 'total_qrdr_n'))
cases_per_month <- select(combined_cases_by_month, c('Month', 'total_typhoid_n'))
prescriptions_per_month <- select(combined_prescrip_by_month, c('Month', 'total_prescrip_n'))
bc_per_month <- select(combined_blood_cultures, c('Month', 'total_bc_n'))

entire_recruitment_period <- data.frame(Month = seq(strataa_start, strataa_end, "months"))
entire_recruitment_period <- left_join(entire_recruitment_period, cases_per_month, by = 'Month')
entire_recruitment_period <- left_join(entire_recruitment_period, prescriptions_per_month, by = 'Month')
entire_recruitment_period <- left_join(entire_recruitment_period, qrdr_per_month, by = 'Month')
entire_recruitment_period <- left_join(entire_recruitment_period, bc_per_month, by = 'Month')

m <- glmmTMB(total_qrdr_n ~ total_prescrip_n + total_bc_n + offset(total_typhoid_n),  data = entire_recruitment_period, family = "nbinom1")
summary(m)
m_summary <- broom.mixed::tidy(m, exponentiate = TRUE, conf.int = TRUE)
m_summary
```

## Combined tyvac_strataa period

Make a dataframe for just the time period that was shared by strataa and tyvac. Then extract the total incidence (the combined strataa and tyvac cases). Then combine all together into a neat data frame.

```{r}
strataa_tyvac_recruitment_period <- data.frame(Month = seq(tyvac_strataa_start, tyvac_strataa_end, "months")) 

cases_incidence_per_month <- select(combined_cases_by_month, c('Month', 'total_typhoid_per100000'))
prescriptions_incidence_per_month <- select(combined_prescrip_by_month, c('Month', 'total_prescrip_per_100000'))
qrdr_incidence_per_month <- select(combined_qrdr_cases_by_month, c('Month', 'total_qrdr_incidence_per_100000'))
bc_incidence_per_month <- select(combined_blood_cultures, c('Month', 'total_bc_per_100000'))

strataa_tyvac_recruitment_period <- left_join(strataa_tyvac_recruitment_period, cases_incidence_per_month, by = 'Month')
strataa_tyvac_recruitment_period <- left_join(strataa_tyvac_recruitment_period, prescriptions_incidence_per_month, by = 'Month')
strataa_tyvac_recruitment_period <- left_join(strataa_tyvac_recruitment_period, qrdr_incidence_per_month, by = 'Month')
strataa_tyvac_recruitment_period <- left_join(strataa_tyvac_recruitment_period, bc_incidence_per_month, by = 'Month')

st_typh <- sum(strataa_tyvac_recruitment_period$total_typhoid_per100000)
st_prescrip <- sum(strataa_tyvac_recruitment_period$total_prescrip_per_100000)
st_qrdr <- sum(strataa_tyvac_recruitment_period$total_qrdr_incidence_per_100000)
st_bc <- sum(strataa_tyvac_recruitment_period$total_bc_per_100000)

```

Per 100,000 people over the STRATAA|TyVAC study period there were:

* `r st_typh` cases of sequencing confirmed typhoid.
* `r st_prescrip` prescriptions of cipro
* `r st_qrdr` QRDR typhoid (ie.. resistant)
* `r st_bc` blood cultures


Run models

```{r run_models}

model_summaries <- run_models(strataa_tyvac_recruitment_period)
model_summaries %>% kbl() %>% kable_styling()

```

## STRATAA only

```{r}
strataa_recruitment_period <- data.frame(Month = seq(strataa_start, strataa_end, "months"))

strataa_cases_incidence_per_month <- select(strataa_cases_by_month, c('Month', 'strataa_typhoid_per100000'))
strataa_prescriptions_incidence_per_month <- select(strataa_presc_by_month, c('Month', 'strataa_prescrip_per100000'))
strataa_qrdr_incidence_per_month <- select(strataa_qrdr_cases_by_month, c('Month', 'strataa_qrdr_incidence_per_100000'))
strataa_bc_incidence_per_month <- select(strataa_blood_cultures_by_month, c('Month', 'strataa_bc_per_100000'))

strataa_recruitment_period <- left_join(strataa_recruitment_period, strataa_cases_incidence_per_month, by = 'Month')
strataa_recruitment_period <- left_join(strataa_recruitment_period, strataa_prescriptions_incidence_per_month, by = 'Month')
strataa_recruitment_period <- left_join(strataa_recruitment_period, strataa_qrdr_incidence_per_month, by = 'Month')
strataa_recruitment_period <- left_join(strataa_recruitment_period, strataa_bc_incidence_per_month, by = 'Month')

strataa_recruitment_period[is.na(strataa_recruitment_period)] <- 0

strataa_recruitment_period <- strataa_recruitment_period %>% rename(total_typhoid_per100000 = strataa_typhoid_per100000, total_qrdr_incidence_per_100000 = strataa_qrdr_incidence_per_100000, total_prescrip_per_100000 = strataa_prescrip_per100000, total_bc_per_100000 = strataa_bc_per_100000)

s_typh <- sum(strataa_recruitment_period$total_typhoid_per100000)
s_prescrip <- sum(strataa_recruitment_period$total_prescrip_per_100000)
s_qrdr <- sum(strataa_recruitment_period$total_qrdr_incidence_per_100000)
s_bc <- sum(strataa_recruitment_period$total_bc_per_100000)

```

Per 100,000 people over the STRATAA study period there were:

* `r s_typh` cases of sequencing confirmed typhoid.
* `r s_prescrip` prescriptions of cipro
* `r s_qrdr` QRDR typhoid (ie.. resistant)
* `r s_bc` blood cultures


```{r run_strataa_models}

model_summaries <- run_models(strataa_recruitment_period)
model_summaries %>% kbl() %>% kable_styling()

```



# Graphs
## Figure 1

This is a figure of the number of S. Typhi at QECH that were cipro sensitive and DCS.

```{r Figure1}

pef_tested_qech_typhi <- all_typhi %>% filter(grepl('QECH', Study)) %>% filter(!is.na(`Cipro MIC res?`))
pef_by_month <- pef_tested_qech_typhi %>% group_by(Month, `Cipro MIC res?`) %>% summarise(n = n())
pef_by_month <- pef_by_month %>% filter(Month >= "2019-01-01")

ggplot(pef_by_month, aes(x = Month, y = n, fill = `Cipro MIC res?`)) + 
  geom_bar(stat = "identity") + 
  ylab("Number of samples") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14))

ggplot(pef_by_month, aes(x = Month, y = n, fill = `Cipro MIC res?`, label = n)) + 
  geom_bar(position = 'fill', stat = "identity") + 
  ylab("Number of samples") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14))
```

### Numbers for Figure 1

```{r}
total_qech_typhi_tested <- sum(pef_by_month$n)
total_qech_typhi_dcs_or_r <- filter(pef_by_month, `Cipro MIC res?` == 'DCS' | `Cipro MIC res?` == 'R' ) %>% pull(n) %>% sum
```

There were `r total_qech_typhi_tested` total qech typhi tested, and `r total_qech_typhi_dcs_or_r` DCS or R.


## Figure 2

Graphs of the combined strataa_tyvac_recruitment_period.

```{r}
plot_typh_presc_qrdr_bc <- function(input_data) {
  typhoid_graph <- ggplot(input_data, aes(x = Month, y = total_typhoid_per100000)) + 
    geom_bar(stat = "identity") + 
    ylab('Sequencing confirmed typhoid\nper 100,000 people')

  cipro_prescrip_graph <- ggplot(input_data, aes(x = Month, y = total_prescrip_per_100000)) + 
    geom_bar(stat = "identity") + 
    ylab('Ciprofloxacin prescriptions\nper 100,000 people')

  qrdr_graph <- ggplot(input_data, aes(x = Month, y = total_qrdr_incidence_per_100000)) + 
    geom_bar(stat = "identity") +
    ylab('S. Typhi with QRDR mutations\nper 100,000 people')

  bc_graph <- ggplot(input_data, aes(x = Month, y = total_bc_per_100000)) + 
    geom_bar(stat = "identity") +
    ylab('Number of blood cultures\nper 100,000 people')

  p <- typhoid_graph / cipro_prescrip_graph / qrdr_graph / bc_graph + plot_layout(heights = c(5,5,5,5))

  return(p)
  
  
}
```

Plot STRATAA only

```{r, fig.width = 6, fig.height = 12}

strataa_only_tpqb_graph <- plot_typh_presc_qrdr_bc(strataa_recruitment_period) # tpqb stands for typhoid, prescriptions, qrdr and blood cultures
strataa_only_tpqb_graph + plot_annotation('STRATAA only')

```

Plot Strataa tyvac overlap

```{r fig.width = 6, fig.height = 12}

strataa_and_tyvac_tpqb_graph <- plot_typh_presc_qrdr_bc(strataa_tyvac_recruitment_period)
strataa_and_tyvac_tpqb_graph + plot_annotation('STRATAA and tyvac')

```








