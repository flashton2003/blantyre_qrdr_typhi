---
title: "DCS Typhi in Blantyre"
author: "Philip Ashton"
date: "30/08/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r message=FALSE}
library(tidyverse)
library(readxl)
library(broom)
library(lubridate)
#library(here)
library(glmmTMB)
library(tsibble)
library(feasts)
library(trending)
library(patchwork)
```

## Key variables

`tyvac_pop` is the ndirande intention to treat population (or should we use the per protocol number?). `strataa_pop` is the population size at the final census (aug 2018-April 2019). `tyvac_strataa_start` and `tyvac_strataa_end` are the start and finish of the period of overlap between strataa and tyvac.

```{r KeyVariables}
tyvac_pop <- 17695 # 
strataa_pop <- 102242 # 
tyvac_strataa_start <- as.Date('2018-05-01')
tyvac_strataa_end <- as.Date('2019-10-01')
```

## Import data

Here we import all the files needed for this analysis.

Todo:

* make sure excluding multiple isolates from the same person (get PIDs for both STRATAA and TyVAC)

```{r ImportData}

line_list_handle <- "~/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2022.04.08/2022.04.08 line list.xlsx"

all_typhi <- read_excel("~/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2022.04.08/2022.04.08 line list.xlsx", col_types = c("text", "text", "text", "text",
        "text", "date", "text", "text", "numeric", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "numeric", 
        "text", "text", "text", "text", "text", 
        "text", "text"))

all_typhi$Month <- as.Date(cut(all_typhi$`Properly formatted date`, breaks = "month"))
all_typhi <- all_typhi %>% mutate(any_qrdr = ifelse(is.na(QRDR), NA, "QRDR")) %>% filter(!grepl("^Ignore", Note))


strataa_prescriptions <- read_csv("/Users/flashton/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2021.04.08/2021.04.01 strataa_ndirande_prescribed from James Meiring.csv", 
    col_types = cols(ps12_dov = col_datetime(format = "%d/%m/%Y %H:%M")))
strataa_prescriptions$Month <- as.Date(cut(strataa_prescriptions$ps12_dov, breaks = "month"))
strataa_prescriptions <- strataa_prescriptions %>% filter(ps44_cipro == 1)

tyvacpresc_by_month <- read_csv("/Users/flashton/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2021.04.08/2021.04.08 cipro prescriptions.csv", col_types = cols(Month = col_date(format = "%d/%m/%Y")))


tyvac_blood_cultures_by_month <- read_csv("~/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2021.11.12/TyVAC monthly BC.csv", col_types = cols(date = col_date(format = "%Y-%m-%d"))) %>% rename('Month' = 'date', 'tyvac_bc_n' = 'BC collected')


strataa_blood_cultures <- read_csv("~/Dropbox/GordonGroup/STRATAA_pefloxacin_resistant_typhi/data_munging/2021.11.12/STRATAA.ps_enrolment.date_only.csv", col_types = cols(ps12_dov = col_date(format = "%Y-%m-%d")))
strataa_blood_cultures$Month <- as.Date(cut(strataa_blood_cultures$ps12_dov, breaks = "month"))

```

## Sequencing confirmed typhoid incidence rate

Here we filter the input line list to extract the tyvac samples from ndirande and the strataa samples 

```{r}
tyvac_cases <- all_typhi %>% filter(Study == 'TyVAC' & `TyVAC site` == 'Ndirande'  & !is.na(`Sequenced?`))
tyvac_cases_by_month <- tyvac_cases %>% group_by(Month) %>% summarise(tyvac_n = n())

strataa_cases <- all_typhi %>% filter(grepl('STRATAA', Study) & !is.na(`Sequenced?`))

strataa_cases_by_month <- strataa_cases  %>% group_by(Month) %>% summarise(strataa_n = n())

#cases_start <- min(strataa_cases_by_month$Month, tyvac_cases_by_month$Month)
#cases_end <- max(strataa_cases_by_month$Month, tyvac_cases_by_month$Month)

# get the official start date of tyvac, as this will determine the start period
combined_cases_by_month <- data.frame(Month = seq(tyvac_strataa_start, tyvac_strataa_end, "months")) 
#combined_by_month <- combined_by_month %>% rename(V1 = Month)
combined_cases_by_month <- left_join(combined_cases_by_month, tyvac_cases_by_month, by = 'Month')
combined_cases_by_month <- left_join(combined_cases_by_month, strataa_cases_by_month, by = 'Month')
combined_cases_by_month[is.na(combined_cases_by_month)] <- 0

combined_cases_by_month$total_n <- combined_cases_by_month$tyvac_n + combined_cases_by_month$strataa_n
combined_cases_by_month$total_typhoid_per100000 <- (combined_cases_by_month$total_n / strataa_pop) * 100000

```

## QRDR typhi incidence

```{r}

strataa_qrdr <- strataa_cases %>% filter(any_qrdr == 'QRDR')
strataa_qrdr_cases_by_month <- strataa_qrdr  %>% group_by(Month) %>% summarise(strataa_qrdr_n = n())

tyvac_qrdr <- tyvac_cases %>% filter(any_qrdr == 'QRDR')
tyvac_qrdr_cases_by_month <- tyvac_qrdr  %>% group_by(Month) %>% summarise(tyvac_qrdr_n = n())

combined_qrdr_cases_by_month <- data.frame(Month = seq(tyvac_strataa_start, tyvac_strataa_end, "months")) 

combined_qrdr_cases_by_month <- left_join(combined_qrdr_cases_by_month, strataa_qrdr_cases_by_month, by = 'Month')
combined_qrdr_cases_by_month <- left_join(combined_qrdr_cases_by_month, tyvac_qrdr_cases_by_month, by = 'Month')

combined_qrdr_cases_by_month[is.na(combined_qrdr_cases_by_month)] <- 0

combined_qrdr_cases_by_month$total_qrdr_n <- combined_qrdr_cases_by_month$strataa_qrdr_n + combined_qrdr_cases_by_month$tyvac_qrdr_n

combined_qrdr_cases_by_month$total_qrdr_incidence_per_100000 <- (combined_qrdr_cases_by_month$total_qrdr_n / strataa_pop) * 100000

```

## cipro prescription incidence rates

```{r}
strpresc_by_month <- strataa_prescriptions %>% group_by(Month) %>% summarise(strataa_prescrip_n = n())
#ggplot(strataa_prescriptions)
#strpresc_by_month$strataa_prescrip_per100000 <- (strpresc_by_month$n / strataa_pop) * 100000

combined_prescrip_by_month <- data.frame(Month = seq(tyvac_strataa_start, tyvac_strataa_end, "months")) 
combined_prescrip_by_month <- left_join(combined_prescrip_by_month, tyvacpresc_by_month, by = 'Month')
combined_prescrip_by_month <- left_join(combined_prescrip_by_month, strpresc_by_month, by = 'Month')
# currently only including prescriptions to eligible tyvac participants, not ineligible
# ineligible prescriptions also add to the total pressure, but it should be negligible compared with the prescriptions
# to eligible people?
combined_prescrip_by_month$total_prescrip_n <- combined_prescrip_by_month$tyvac_eligible_ciprofloxacin_prescribed + combined_prescrip_by_month$strataa_prescrip_n

combined_prescrip_by_month$total_prescrip_per_100000 <- (combined_prescrip_by_month$total_prescrip_n / strataa_pop) * 100000

#tyvacpresc_by_month$tyvac_prescrip_eligible_per100000 <- (tyvacpresc_by_month$tyvac_eligible_ciprofloxacin_prescribed / tyvac_pop) * 100000
#tyvacpresc_by_month$tyvac_prescrip_not_eligible_per100000 <- (tyvacpresc_by_month$tyvac_not_eligible_ciprofloxacin_prescribed / tyvac_pop) * 100000

#prescrip_end <- max(strataa_prescriptions$Month, tyvacpresc_by_month$Month)
##prescrip_start <- min(strataa_prescriptions$Month, tyvacpresc_by_month$Month)



```

## Getting the number of blood cultures

```{r}

strataa_blood_cultures_by_month <- strataa_blood_cultures %>% group_by(Month) %>% summarise(strataa_blood_cultures_n = n())


combined_blood_cultures <- data.frame(Month = seq(tyvac_strataa_start, tyvac_strataa_end, "months"))
combined_blood_cultures <- left_join(combined_blood_cultures, tyvac_blood_cultures_by_month, by = 'Month')

combined_blood_cultures <- left_join(combined_blood_cultures, strataa_blood_cultures_by_month, by = 'Month')

combined_blood_cultures$total_n <- combined_blood_cultures$tyvac_bc_n + combined_blood_cultures$strataa_blood_cultures_n
combined_blood_cultures$total_bc_per_100000 <- (combined_blood_cultures$total_n / strataa_pop) * 100000

```


## Investigating associations

Get neat dataframe together

```{r}

everything_for_model <- data.frame(Month = seq(tyvac_strataa_start, tyvac_strataa_end, "months")) 
cases_incidence_per_month <- select(combined_cases_by_month, c('Month', 'total_typhoid_per100000'))
prescriptions_incidence_per_month <- select(combined_prescrip_by_month, c('Month', 'total_prescrip_per_100000'))
qrdr_incidence_per_month <- select(combined_qrdr_cases_by_month, c('Month', 'total_qrdr_incidence_per_100000'))
bc_incidence_per_month <- select(combined_blood_cultures, c('Month', 'total_bc_per_100000'))

everything_for_model <- left_join(everything_for_model, cases_incidence_per_month, by = 'Month')
everything_for_model <- left_join(everything_for_model, prescriptions_incidence_per_month, by = 'Month')
everything_for_model <- left_join(everything_for_model, qrdr_incidence_per_month, by = 'Month')
everything_for_model <- left_join(everything_for_model, bc_incidence_per_month, by = 'Month')


```

From PeterMacP:

"Model 1: Here we are testing the hypothesis that increased month presciptions of ciprofloxacin was associated with increased numbers of cases of drug resistant typhoid.

We will initially construct a zero-inflated negative binomial regression model to investigate this association. We select the zero-inflated negative binomial distributional family because it is likely that the data are overdispersed, and because of the excess zero months."

Question: what part of this model specification specifies a zero-inflated model?

```{r}

m1 <- glmmTMB(total_qrdr_incidence_per_100000 ~ total_prescrip_per_100000,  data = everything_for_model, family = "nbinom1")

summary(m1)

broom.mixed::tidy(m1, exponentiate = TRUE, conf.int = TRUE)

```


Model 2 - include the number of tests done in the model

```{r}
m2 <- glmmTMB(total_qrdr_incidence_per_100000 ~ total_prescrip_per_100000 + total_bc_per_100000,  data = everything_for_model, family = "nbinom1")

summary(m2)

broom.mixed::tidy(m2, exponentiate = TRUE, conf.int = TRUE)

```


Model 3 - include number of tests and number of positions

```{r}
m3 <- glmmTMB(total_qrdr_incidence_per_100000 ~ total_prescrip_per_100000 + total_bc_per_100000 + total_typhoid_per100000,  data = everything_for_model, family = "nbinom1")

summary(m3)
broom.mixed::tidy(m3, exponentiate = TRUE, conf.int = TRUE)


```

## Figure 1

This is a figure of the number of S. Typhi at QECH that were cipro sensitive and DCS.

```{r Figure1 message=FALSE}

pef_tested_qech_typhi <- all_typhi %>% filter(grepl('QECH', Study)) %>% filter(!is.na(`Cipro MIC res?`))
pef_by_month <- pef_tested_qech_typhi %>% group_by(Month, `Cipro MIC res?`) %>% summarise(n = n())
pef_by_month <- pef_by_month %>% filter(Month >= "2019-01-01")

ggplot(pef_by_month, aes(x = Month, y = n, fill = `Cipro MIC res?`)) + 
  geom_bar(stat = "identity") + 
  ylab("Number of samples") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14))

ggplot(pef_by_month, aes(x = Month, y = n, fill = `Cipro MIC res?`, label = n)) + 
  geom_bar(position = 'fill', stat = "identity") + 
  ylab("Number of samples") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14))
```

## Numbers for Figure 1

```{r}
total_qech_typhi_tested <- sum(pef_by_month$n)
total_qech_typhi_dcs_or_r <- filter(pef_by_month, `Cipro MIC res?` == 'DCS' | `Cipro MIC res?` == 'R' ) %>% pull(n) %>% sum
```

There were `r total_qech_typhi_tested` total qech typhi tested, and `r total_qech_typhi_dcs_or_r` DCS or R.


## Figure 2

```{r Figure2.v2}

typhoid_graph <- ggplot(everything_for_model, aes(x = Month, y = total_typhoid_per100000)) + 
  geom_bar(stat = "identity") + 
  ylab('Sequencing confirmed typhoid\nper 100,000 people')

cipro_prescrip_graph <- ggplot(everything_for_model, aes(x = Month, y = total_prescrip_per_100000)) + 
  geom_bar(stat = "identity") + 
  ylab('Ciprofloxacin prescriptions\nper 100,000 people')

qrdr_graph <- ggplot(everything_for_model, aes(x = Month, y = total_qrdr_incidence_per_100000)) + 
  geom_bar(stat = "identity") +
  ylab('S. Typhi with QRDR mutations\nper 100,000 people')

qrdr_graph

bc_graph <- ggplot(everything_for_model, aes(x = Month, y = total_bc_per_100000)) + 
  geom_bar(stat = "identity") +
  ylab('Number of blood cultures\nper 100,000 people')


p <- typhoid_graph / cipro_prescrip_graph / qrdr_graph / bc_graph

```








