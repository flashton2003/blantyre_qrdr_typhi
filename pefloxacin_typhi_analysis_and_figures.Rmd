---
title: "pefloxacin typhi analysis and figures"
author: "Philip Ashton"
date: "`r Sys.Date()`"
output: html_document
---

# Libraries

```{r message=FALSE}
library(tidyverse)
library(glmmTMB)
library(patchwork)
library(kableExtra)
library(broom)

source('pefloxacin_typhi_functions.R')
```

# Read in data

```{r}
cases_bc_qrdr_prescrip_microconf_handle <- 'data/2022.09.14.pef_typhi.cases_bc_qrdr_prescrip_microconf.csv'
qech_pef_by_month_handle <- 'data/2022.09.14.qech_pef_results_per_month.csv' 
strataa_tyvac_qrdr_typhi_handle <- 'data/2022.09.15.strataa_tyvac_qrdr_typhi.one_per_patient.csv'
tree_summaries_handle <- 'data/2022.09.16.tree_summaries.csv'
```

Data has been pulled in from various sources and cleaned using `pefloxacin_typhi_data_cleaning.Rmd`. The clean data has been saved as `data/cases_bc_qrdr_prescrip_microconf_handle`.

```{r}

entire_recruitment_period <- read_csv(cases_bc_qrdr_prescrip_microconf_handle)
```

# STRATAA/TyVAC data summary

The number of sequencing confirmed typhoid cases and number of qrdr (sequencing confirmed), number of prescriptions of cipro, number of blood cultures, and number of microbiologically confirmed typhoid.

```{r}
typh_n <- sum(entire_recruitment_period$total_typhoid_n)
prescrip_n <- sum(entire_recruitment_period$total_prescrip_n)
qrdr_n <- sum(entire_recruitment_period$total_qrdr_n)
bc_n <- sum(entire_recruitment_period$total_bc_n)
micro_conf_opp_n <- sum(entire_recruitment_period$micro_confirmed_opp_n)
micro_conf_all_n <- sum(entire_recruitment_period$micro_confirmed_all_n)
```


In total, over the entire study period there were:

* `r micro_conf_opp_n` cases of microbiologically confirmed typhoid (one per patient).
* `r micro_conf_all_n` isolates S. Typhi.
* `r typh_n` cases of sequencing confirmed typhoid.
* `r prescrip_n` prescriptions of cipro
* `r qrdr_n` QRDR typhoid (i.e. resistant)
* `r format(bc_n, scientific=FALSE)` blood cultures


# Investigating associations

After discussion with Marc, want to do one model with all the data from the entire study period. It doesn't matter about the difference in recruitment criteria between strataa and tyvac because the important thing is the number of qrdr typhi per typhoid case, and the method of detecting those was consistent.


Peter code here


```{r glm model}

m <- glm(cbind(total_qrdr_n, total_typhoid_n-total_qrdr_n) ~ total_prescrip_n + total_bc_n,  
         data = entire_recruitment_period, 
         family = "binomial")

summary(m)
m_summary <- broom.mixed::tidy(m, exponentiate = TRUE, conf.int = TRUE)
m_summary  %>% kbl() %>% kable_styling()

preds <- augment(m, newdata = entire_recruitment_period, se_fit = TRUE) %>%
  mutate(.lower=.fitted-1.96*.se.fit, 
         .upper=.fitted+1.96*.se.fit) %>%
  mutate_at(.vars = vars(.fitted, .lower, .upper),
            .funs = funs(plogis))

preds %>%
  ggplot(aes(y=.fitted, ymin=.lower, ymax=.upper, x=Month)) +
  geom_pointrange(alpha=0.5) +
  geom_point(aes(x=Month, y=total_qrdr_n/total_typhoid_n), colour="firebrick", alpha=0.5, shape=4) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  scale_x_date() +
  labs(y="Predicted % of typhoid cases with drug resistance\n(95% CI)")

```

Just check with a bayesian model.

```{r bayesian model}
library(brms)
library(tidybayes)

#with a binomial distribution
m2 <- brm(bf(total_qrdr_n | trials(total_typhoid_n) ~ total_prescrip_n + total_bc_n),
          data = entire_recruitment_period, 
          family = binomial(),
          chains = 4)

summary(m2)
plot(m2)
pp_check(m2)
#understimates the zeros

preds2 <- entire_recruitment_period %>%
  add_epred_draws(m2) %>%
  mean_qi()

preds2

preds2 %>%
  mutate(.epred_prev = .epred/total_typhoid_n,
         .lower_prev = .lower/total_typhoid_n,
         .upper_prev = .upper/total_typhoid_n) %>%
  ggplot(aes(x=Month, y =.epred_prev, ymin=.lower_prev, ymax=.upper_prev)) +
  geom_pointrange() +
  scale_y_continuous(labels = scales::percent, limits = c(0,1))



```





Todo:

1. Need to do the serial autocorrelation analysis
2. Compare AIC of nested models, e.g. https://www.scribbr.com/statistics/akaike-information-criterion/ 

# Graphs
## Figure 1

This is a figure of the number of S. Typhi at QECH that were cipro sensitive and DCS.

```{r Figure1, fig.width = 8, fig.height = 10}

qech_pef_by_month <- read_csv(qech_pef_by_month_handle)

qech_n_graph <- ggplot(qech_pef_by_month, aes(x = Month, y = n, fill = `Cipro MIC res?`)) + 
  geom_bar(stat = "identity") + 
  ylab("Count") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  ggtitle('A)')

qech_prop_graph <- ggplot(qech_pef_by_month, aes(x = Month, y = n, fill = `Cipro MIC res?`, label = n)) + 
  geom_bar(position = 'fill', stat = "identity") + 
  ylab("Proportion") +
  theme(axis.text=element_text(size=12), axis.title=element_text(size=14)) +
  ggtitle('B)')


qech_n_graph / qech_prop_graph #+ plot_layout(heights = c(100, 100))

```

### Numbers for Figure 1

```{r}
total_qech_typhi_tested <- sum(qech_pef_by_month$n)
total_qech_typhi_dcs_or_r <- filter(qech_pef_by_month, `Cipro MIC res?` == 'DCS' | `Cipro MIC res?` == 'R' ) %>% pull(n) %>% sum
```

There were `r total_qech_typhi_tested` total qech typhi tested, and `r total_qech_typhi_dcs_or_r` DCS or R.


## Figure 2

Graphs of the counts of typhi cases, qrdr cases, cipro prescriptions and blood cultures from the entire strataa/tyvac recruitment period.

```{r, fig.width = 6, fig.height = 12}


entire_period_tpqb_graph <- plot_typh_presc_qrdr_bc_n(entire_recruitment_period) # tpqb stands for typhoid, prescriptions, qrdr and blood cultures
entire_period_tpqb_graph + plot_annotation('Combined STRATAA & TyVAC period')

```

### Numbers for Figure 2

```{r}
strataa_tyvac_qrdr_typhi <- read_csv(strataa_tyvac_qrdr_typhi_handle, col_types = cols(`Properly formatted date` = col_date(format = "%Y-%m-%d")))
qrdr_before_sept019 <- strataa_tyvac_qrdr_typhi %>% filter(`Properly formatted date` < '2019-09-01')
qrdr_sept_oct2019 <- strataa_tyvac_qrdr_typhi %>% filter(`Properly formatted date` >= '2019-09-01' & `Properly formatted date` <= '2019-10-31')

mutations_before_sept2019 <- qrdr_before_sept019 %>% group_by(QRDR) %>% summarise(n = n())
mutations_sept_oct2019 <- qrdr_sept_oct2019 %>% group_by(QRDR) %>% summarise(n = n())

```

There were `r nrow(qrdr_before_sept019)` QRDR Typhi isolated between 1st October 2016 and 31th August 2019.

There were `r nrow(qrdr_sept_oct2019)` QRDR Typhi isolated between 1st September 2019 and 31st October 2019.

Before Sept2019
`r mutations_before_sept2019  %>% kbl() %>% kable_styling()`
Sept-Oct 2019
`r mutations_sept_oct2019  %>% kbl() %>% kable_styling()`


# Summaries of the numbers in each phylo


```{r}
all_tree_summaries <- read_csv(tree_summaries_handle)
context <- all_tree_summaries %>% filter(tree == 'malawian_and_context') %>% filter(Country != 'Malawi')

number_of_nonmalawian_context_genomes <- sum(context$n)
```

There were `r number_of_nonmalawian_context_genomes` non-Malawian contextual genomes included in the analysis.

Table of the number of genomes included from each location in each tree.

`r all_tree_summaries %>% kbl() %>% kable_styling()`

